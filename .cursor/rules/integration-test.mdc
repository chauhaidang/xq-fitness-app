---
description: "when implementing, fixing, or updating mobile integration tests, follow this workflow"
alwaysApply: false
---

# Mobile Integration Test Rules

When running or updating integration tests for the mobile app, follow the project's standard workflow. Integration tests make **real API calls** to the gateway and require the backend (read service, write service, gateway) to be running.

## Principles

- **Integration tests use real API calls.** No mocks or stubs for API services. Tests call the actual gateway URL; request and response payloads must match the API contracts (`api/read-service-api.yaml`, `api/write-service-api.yaml`).
- **Test location:** All integration tests live in `__tests__/integration/` and use the `*.integration.test.js` naming pattern.
- **Use test utilities:** Use `renderScreenWithApi`, `waitForApiCall`, `waitForLoadingToFinish`, `createTestRoutine` from `__tests__/integration/helpers/test-utils.js`. Do not mock the API module in integration tests.

## Workflow: Running Integration Tests Locally

### 1. Spin up the test environment with xq-infra

- Install xq-cli if needed: `npm install -g @chauhaidang/xq-test-infra@1.0.3`
- From the **mobile/** directory (same directory as `test-env/`):

```bash
xq-infra generate -f ./test-env
xq-infra up
```

The test environment is defined in **test-env/** (xq-fitness-db, xq-fitness-read-service, xq-fitness-write-service, and the auto-injected xq-gateway). Do not use a different path.

### 2. Run integration tests

From **mobile/**:

```bash
npm run test:integration
```

Defaults use the test-env gateway: `GATEWAY_URL=http://localhost:8080`. The app resolves:
- Read Service: `${GATEWAY_URL}/xq-fitness-read-service/api/v1`
- Write Service: `${GATEWAY_URL}/xq-fitness-write-service/api/v1`

To use a custom gateway URL:

```bash
GATEWAY_URL=http://localhost:8080 npm run test:integration
```

### 3. Optional: run in watch mode

```bash
npm run test:integration:watch
```

### 4. Tear down (optional)

From the same directory where you ran `xq-infra up`:

```bash
xq-infra down
```

## Test structure and conventions

- **File naming:** `*Screen.integration.test.js` or `*Flow.integration.test.js` (e.g. `SnapshotReportFlow.integration.test.js`).
- **Config:** Integration tests use `jest.integration.config.js` (testMatch: `**/__tests__/integration/**/*.integration.test.{js,jsx}`, setup from `__tests__/integration/setup.js`, timeout 30000, maxWorkers: 1).
- **Unit vs integration:** Run only unit tests with `npm run test:unit` (excludes integration). Run all tests with `npm run test:all`.

## Port conflicts

- If the environment fails to start or you see "address already in use", check for other stacks (e.g. read-service or write-service test env) using the same ports. Run `xq-infra down` in those service directories or stop conflicting containers.
- Avoid running multiple test envs that share host ports (e.g. 5432 for DB, 8080 for gateway).

## Summary checklist

- [ ] Run `xq-infra generate -f ./test-env` and `xq-infra up` from **mobile/**.
- [ ] Run `npm run test:integration` from **mobile/** (uses `GATEWAY_URL=http://localhost:8080` by default).
- [ ] Use real API calls; do not mock the API in integration tests.
- [ ] If startup fails, check container port conflicts and other services' test envs.
